rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {
    function signedIn() { 
      return request.auth != null; 
    }
    
    function isOwner(ownerId) {
      return signedIn() && request.auth.uid == ownerId;
    }
    
    function isRequester(requesterId) {
      return signedIn() && request.auth.uid == requesterId;
    }
    
    function isRequestParticipant(requestData) {
      return signedIn() && (
        request.auth.uid == requestData.ownerId || 
        request.auth.uid == requestData.requesterId
      );
    }

    // Books collection
    match /books/{id} {
      allow read: if true;
      allow create: if signedIn();
      allow update, delete: if signedIn() && resource.data.ownerId == request.auth.uid;
    }

    // Requests collection
    match /requests/{requestId} {
      allow read, create: if signedIn();
      allow update: if signedIn() && resource.data.ownerId == request.auth.uid;
      
      // Messages subcollection - only participants can read/write
      match /messages/{messageId} {
        // Allow read if user is owner or requester of the parent request
        allow read: if signedIn() && (
          get(/databases/$(db)/documents/requests/$(requestId)).data.ownerId == request.auth.uid ||
          get(/databases/$(db)/documents/requests/$(requestId)).data.requesterId == request.auth.uid
        );
        
        // Allow create if user is owner or requester of the parent request
        allow create: if signedIn() && (
          get(/databases/$(db)/documents/requests/$(requestId)).data.ownerId == request.auth.uid ||
          get(/databases/$(db)/documents/requests/$(requestId)).data.requesterId == request.auth.uid
        ) && request.resource.data.senderId == request.auth.uid;
        
        // Don't allow update or delete (messages are immutable)
        allow update, delete: if false;
      }
    }
  }
}

